# ADR-0004: テスト戦略

## ステータス

採用

## 背景

開発効率と品質のバランスを考慮したテスト戦略の策定が必要だった。

## 決定事項

**データアクセス層のみをテスト対象とし、ルートハンドラはテストしない。**

### テスト対象
- ✅ **データアクセス層** (`src/db/messages.ts`)
  - `getMessages()`: ページネーション、並び順
  - `createMessage()`: 挿入処理
  - `getMessageCount()`: 件数取得

### テスト対象外
- ❌ **ルートハンドラ** (`src/routes/*.ts`)
- ❌ **ビューコンポーネント** (`src/views/*.ts`)

### テストツール
- **Node.js Test Runner**: 標準機能を使用
- **In-Memory Database**: SQLite `:memory:` でテスト実行

## 理由

### データアクセス層をテストする理由
1. **ビジネスロジックの中核**: データ操作が最も重要
2. **複雑性**: SQLクエリ、ページネーション、並び順のロジック
3. **バグの影響大**: データ破損や不整合は致命的
4. **テストが書きやすい**: 入出力が明確で副作用が限定的

### ルートハンドラをテストしない理由
1. **シンプルさ**: 薄いラッパー層で複雑なロジックがない
2. **テストコスト**: HTTPリクエスト/レスポンスのモック化が煩雑
3. **費用対効果**: テストの価値が低い

### ビューコンポーネントをテストしない理由
1. **テンプレート**: ロジックがほとんどない
2. **視覚的確認**: ブラウザでの手動確認が効果的

## テスト実装の原則

### 独立性
- 各テストは独立して実行可能
- `beforeEach`でDBをクリア
- In-Memoryデータベースを使用

### カバレッジ
データアクセス層の主要な機能をカバー：
- 正常系のテスト
- ページネーションの動作確認
- 並び順の検証

## 結果

### 良い点
- テストコードがシンプルで保守しやすい
- CI/CDでの実行が高速（DB初期化不要）
- 重要なロジックに集中してテスト

### 悪い点
- ルートハンドラのバグは検出できない
- E2Eテストがないため、統合的な動作確認は手動

### トレードオフ
- テストカバレッジよりも開発効率を優先
- シンプルなアプリケーションではこれで十分
- 重要な部分（データアクセス）は確実にテスト

## 今後の拡張
アプリケーションが複雑化した場合：
1. 統合テスト追加を検討
2. E2Eテスト（Playwright等）の導入を検討
3. ルートハンドラにロジックが増えた場合はテスト追加
